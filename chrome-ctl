#! /bin/bash

# =============================================================================
# Antigravity Smart Proxy Manager
# =============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd) || exit"
PROXY_SCRIPT="$SCRIPT_DIR/smart_chrome_proxy.py"
LOG_FILE="/tmp/smart_proxy.log"

case "$1" in
    status)
        echo "ðŸ” Checking Antigravity Proxy..."
        PID=$(pgrep -f "smart_chrome_proxy.py")
        if [ -n "$PID" ]; then
            echo "âœ… Smart Proxy is active (PID: $PID)"
            echo "   Route: 127.0.0.1:9222 (Stealth Bridge) -> Proxy"
        else
            echo "âŒ Smart Proxy is NOT running"
        fi
        
        echo ""
        echo "ðŸ” Checking Chrome instances..."
        # Check for any Chrome running under the Antigravity profile
        CHROME_PIDS=$(pgrep -f "antigravity_chrome")
        if [ -n "$CHROME_PIDS" ]; then
             echo "âœ… Chrome is running (Managed by Proxy)"
        else
             echo "ðŸ’¤ Chrome is sleeping (Auto-starts on demand)"
        fi
        ;;
        
    start)
        if pgrep -f "smart_chrome_proxy.py" > /dev/null; then
            echo "âš ï¸  Proxy is already running."
        else
            echo "ðŸš€ Starting Smart Proxy..."
            nohup python3 "$PROXY_SCRIPT" > "$LOG_FILE" 2>&1 &
            echo "âœ… Started background service."
        fi
        ;;
        
    stop)
        echo "ðŸ›‘ Stopping services..."
        pkill -f "smart_chrome_proxy.py" || true
        pkill -f "chrome.*antigravity" 2>/dev/null || true
        echo "âœ… All stopped."
        ;;
        
    restart)
        echo "ðŸ”„ Restarting..."
        $0 stop
        sleep 1
        $0 start
        ;;
        
    logs)
        echo "ðŸ“‹ Proxy Logs:"
        tail -n 20 "$LOG_FILE" 2>/dev/null
        ;;
        
    *)
        echo "Usage: chrome-ctl {status|start|stop|restart|logs}"
        exit 1
        ;;
esac
