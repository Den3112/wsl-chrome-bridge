#!/bin/bash

# =============================================================================
# Quick commands for managing Antigravity Chrome
# =============================================================================

case "$1" in
    status)
        echo "üîç Checking Chrome status..."
        if curl -s --connect-timeout 2 http://127.0.0.1:9222/json/version > /dev/null 2>&1; then
            echo "‚úÖ Chrome is running on port 9222"
            curl -s http://127.0.0.1:9222/json/version | grep -oP '"Browser": "\K[^"]+'
        else
            echo "‚ùå Chrome is not responding (this is normal if you're not using it)"
        fi
        
        echo ""
        echo "üîç Checking Watchdog..."
        if [ -f /tmp/antigravity_chrome_watchdog.pid ]; then
            PID=$(cat /tmp/antigravity_chrome_watchdog.pid)
            if ps -p "$PID" > /dev/null 2>&1; then
                echo "‚úÖ Watchdog is running (PID: $PID) - passive mode"
            else
                echo "‚ö†Ô∏è  Watchdog not running (old PID: $PID)"
            fi
        else
            echo "‚ùå Watchdog is not running"
        fi
        ;;
        
    start)
        echo "üöÄ Starting Chrome manually..."
        bash /home/creator/ensure_chrome_running.sh
        ;;
        
    restart)
        echo "üîÑ Restarting Chrome..."
        pkill -f "chrome.*9222" 2>/dev/null || true
        sleep 2
        bash /home/creator/ensure_chrome_running.sh
        ;;
        
    logs)
        echo "üìã Chrome logs (last 20 lines):"
        echo "---"
        tail -20 /tmp/antigravity_chrome.log 2>/dev/null || echo "No logs"
        echo ""
        echo "üìã Watchdog logs (last 20 lines):"
        echo "---"
        tail -20 /tmp/antigravity_chrome_watchdog.log 2>/dev/null || echo "No logs"
        ;;
        
    stop)
        echo "üõë Stopping Chrome..."
        pkill -f "chrome.*9222" 2>/dev/null || true
        rm -f /tmp/chrome_auto_start.lock
        echo "‚úÖ Stopped"
        echo "‚ÑπÔ∏è  Chrome will NOT auto-restart"
        ;;
        
    watchdog-stop)
        echo "üõë Stopping Watchdog..."
        if [ -f /tmp/antigravity_chrome_watchdog.pid ]; then
            kill $(cat /tmp/antigravity_chrome_watchdog.pid) 2>/dev/null || true
            rm /tmp/antigravity_chrome_watchdog.pid
        fi
        echo "‚úÖ Watchdog stopped"
        ;;
        
    watchdog-start)
        echo "üöÄ Starting Watchdog..."
        bash /home/creator/start_chrome_watchdog.sh
        ;;
        
    *)
        echo "Antigravity Chrome - Management Tool (Improved Version)"
        echo ""
        echo "Usage: chrome-ctl <command>"
        echo ""
        echo "Commands:"
        echo "  status         - Check Chrome and Watchdog status"
        echo "  start          - Start Chrome manually"
        echo "  restart        - Restart Chrome"
        echo "  stop           - Stop Chrome"
        echo "  watchdog-start - Start Watchdog"
        echo "  watchdog-stop  - Stop Watchdog"
        echo "  logs           - Show logs"
        echo ""
        echo "‚ÑπÔ∏è  New behavior:"
        echo "   ‚Ä¢ Chrome starts ONLY when Antigravity accesses it"
        echo "   ‚Ä¢ If you close the window - it will NOT reopen automatically"
        echo "   ‚Ä¢ Watchdog runs in passive mode (monitoring only)"
        echo ""
        echo "Examples:"
        echo "  chrome-ctl status"
        echo "  chrome-ctl start"
        ;;
esac
