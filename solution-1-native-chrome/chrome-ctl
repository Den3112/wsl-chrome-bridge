#!/bin/bash

# =============================================================================
# Quick commands for managing Antigravity Smart Proxy
# =============================================================================

# Determine directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROXY_SCRIPT="$SCRIPT_DIR/smart_chrome_proxy.py"
LOG_FILE="/tmp/smart_proxy.log"

PROXY_PID_CMD="pgrep -f smart_chrome_proxy.py"

case "$1" in
    status)
        echo "üîç Checking Smart Proxy status..."
        PID=$($PROXY_PID_CMD)
        if [ -n "$PID" ]; then
            echo "‚úÖ Smart Proxy is running (PID: $PID)"
            echo "   Listening on port 9222 -> Chrome on 9223"
        else
            echo "‚ùå Smart Proxy is NOT running"
        fi
        
        echo ""
        echo "üîç Checking Chrome status..."
        if curl -s --connect-timeout 2 http://127.0.0.1:9223/json/version > /dev/null 2>&1; then
            echo "‚úÖ Chrome is running on internal port 9223"
        else
            echo "üí§ Chrome is currently sleeping (will start on demand)"
        fi
        ;;
        
    start)
        echo "üöÄ Starting Smart Proxy..."
        if [ -n "$($PROXY_PID_CMD)" ]; then
            echo "‚ö†Ô∏è  Already running."
        else
            nohup python3 "$PROXY_SCRIPT" > "$LOG_FILE" 2>&1 &
            echo "‚úÖ Started."
        fi
        ;;
        
    stop)
        echo "üõë Stopping Smart Proxy and Chrome..."
        pkill -f "smart_chrome_proxy.py" || true
        pkill -f "chrome.*9223" 2>/dev/null || true
        echo "‚úÖ All stopped."
        ;;
        
    restart)
        echo "üîÑ Restarting Smart Proxy..."
        pkill -f "smart_chrome_proxy.py" || true
        sleep 1
        nohup python3 "$PROXY_SCRIPT" > "$LOG_FILE" 2>&1 &
        echo "‚úÖ Restarted."
        ;;
        
    logs)
        echo "üìã Smart Proxy logs (last 20 lines):"
        echo "---"
        tail -20 "$LOG_FILE" 2>/dev/null || echo "No logs"
        ;;
        
    *)
        echo "Antigravity Smart Proxy - Management Tool"
        echo ""
        echo "Usage: chrome-ctl <command>"
        echo ""
        echo "Commands:"
        echo "  status   - Check Proxy and Chrome status"
        echo "  start    - Start the Smart Proxy"
        echo "  stop     - Stop Proxy and Chrome"
        echo "  restart  - Restart Proxy"
        echo "  logs     - Show proxy logs"
        echo ""
        echo "‚ÑπÔ∏è  Logic:"
        echo "   ‚Ä¢ Proxy listens on 9222."
        echo "   ‚Ä¢ Chrome runs on 9223 ONLY when needed."
        echo "   ‚Ä¢ No more auto-restarting zombies!"
        ;;
esac
